---
import type { GetStaticPaths } from "astro";
import Layout from "@/layouts/Layout.astro";
import { db, terms, definitions, definitionVotes } from "../../lib/server/db";
import { eq, and } from "drizzle-orm";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import TermCard from "@/components/TermCard";
import { auth } from "@/lib/server/auth";

export const prerender = false;

// Get the term slug from URL params
const { term: termSlug } = Astro.params;

if (!termSlug) {
  return Astro.redirect("/404");
}

// Get the current user session
const session = await auth.api.getSession({ headers: Astro.request.headers });
const userId = session?.user?.id;

// Fire both queries concurrently ğŸš€
const [termData, userVotes] = await Promise.all([
  db.query.terms.findFirst({
    where: eq(terms.slug, termSlug),
    with: {
      definitions: {
        with: {
          references: {
            with: {
              referencedTerm: true,
            },
          },
        },
      },
    },
  }),
  userId
    ? db
        .select()
        .from(definitionVotes)
        .where(eq(definitionVotes.userId, userId))
    : Promise.resolve([]),
]);

if (!termData) {
  return Astro.redirect("/404");
}

// Create a map of definitionId -> voteType for quick lookup
const voteMap = new Map(userVotes.map((v) => [v.definitionId, v.voteType]));
---

<Layout
  title={`${termData.term} - Argko.gr`}
  description={termData.definitions[0]?.text || `ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± ${termData.term}`}
>
  <main class="mx-auto">
    <article>
      <Breadcrumbs
        className="mb-5"
        term={`${termData.term} (#${termData.slug})`}
      />

      <section class="">
        {
          termData.definitions
            .sort((a, b) => b.upvotes - b.downvotes - (a.upvotes - a.downvotes))
            .map((def: any) => {
              const references = def.references
                .filter((ref: any) => ref.referencedTerm.id !== termData.id)
                .map((ref: any) => ({
                  term: ref.referencedTerm.term,
                  slug: ref.referencedTerm.slug,
                }));

              const userVote = voteMap.get(def.id) || null;

              return (
                <TermCard
                  term={termData.term}
                  definitionId={def.id}
                  initialVotes={def.upvotes - def.downvotes}
                  initialUserVote={userVote}
                  title={def.text}
                  example={def.example || undefined}
                  submittedBy={termData.submittedBy || "Î‘ÏÏ‡ÎµÎ¯Î¿"}
                  references={references}
                  client:load
                />
              );
            })
        }
      </section>
    </article>
  </main>
</Layout>
